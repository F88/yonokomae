import{u as l}from"./index-BvQox0Ct.js";import{a as g}from"./delay-utils-lugK4fzg.js";class f{api;delay;cacheTtlMs;cache=null;chooseSource;chooseVariant;constructor(t,e){this.api=t,this.delay=e?.delay,this.cacheTtlMs=Math.max(0,e?.cacheTtlMs??3e4),this.chooseSource=e?.chooser??(()=>Math.random()<.2?"ipify":"weather"),this.chooseVariant=e?.variantChooser??(a=>{const i=Math.random(),o=Math.floor(i*a);return o>=0&&o<a?o:0})}async generateReport(t){await g(this.delay,t?.signal);const e=Date.now();if(this.cache&&this.cache.expiresAt>e)return this.cache.value;const a=this.chooseSource();try{const i=a==="ipify"?await this.generateFromIpify(t?.signal):await this.generateWeatherForecast(t?.signal);return this.maybeStoreCache(i),i}catch{const i=await this.api.get("/news/battle/report",t?.signal);return this.maybeStoreCache(i),i}}maybeStoreCache(t){this.cacheTtlMs!==0&&(this.cache={value:t,expiresAt:Date.now()+this.cacheTtlMs})}async generateFromIpify(t){const e=await fetch("https://api.ipify.org?format=json",{headers:{Accept:"application/json"},signal:t});if(!e.ok)throw new Error(`ipify HTTP ${e.status}`);const a=await e.json(),i=typeof a?.ip=="string"&&a.ip?a.ip:"0.0.0.0",o=i.replace(/[^\d]/g,""),s=o?parseInt(o.slice(-6),10):42,r=s%50+25,n=Math.floor(s/7)%50+25;return{id:l("battle"),title:`IPアドレス ${i}`,subtitle:"Generated from ipify.org",overview:"A network-sourced battle report generated from your current public IP.",scenario:"Signal intelligence gathered from ipify inspires a spontaneous skirmish.",provenance:[{label:"ipify - A Simple Public IP Address API",url:"https://ipify.org",note:"The public IP address used to generate this report."}],yono:{imageUrl:"/yonokomae/YONO-SYMBOL.png",title:"Yono - IP Signal",subtitle:"Live network signal",description:"インターネット便利ねー",power:r},komae:{imageUrl:"/yonokomae/KOMAE-SYMBOL.png",title:"Komae - IP Signal",subtitle:"Live network signal",description:"インターネット便利なー",power:n},status:"success"}}async generateWeatherForecast(t){const e=await this.fetchWeatherSnapshot(t),a=this.buildBattlesFromWeatherSnapshot(e),i=this.chooseVariant(a.length);return a[i]??a[0]}async fetchWeatherSnapshot(t){const e={latitude:[35.88445483617253,35.63497080831211],longitude:[139.6262162096776,139.5789225059554],daily:["temperature_2m_max","daylight_duration","sunshine_duration","rain_sum","wind_speed_10m_max"],timezone:"Asia/Tokyo",past_days:1,forecast_days:1},a="https://api.open-meteo.com/v1/forecast",i=new URLSearchParams({latitude:e.latitude.join(","),longitude:e.longitude.join(","),daily:e.daily.join(","),timezone:e.timezone,past_days:String(e.past_days),forecast_days:String(e.forecast_days)}),o=await fetch(`${a}?${i.toString()}`,{headers:{Accept:"application/json"},signal:t});if(!o.ok)throw new Error(`open-meteo HTTP ${o.status}`);const r=(await o.json())?.daily??{},n=(h,y)=>Array.isArray(h)&&h.length>0?h:y,c=n(r.temperature_2m_max,[20,20]).map(Number),m=n(r.wind_speed_10m_max,[5,5]).map(Number),d=n(r.sunshine_duration,[28800,28800]).map(Number),u=n(r.daylight_duration,[43200,43200]).map(Number),p=n(r.rain_sum,[0,0]).map(Number);return{tmax:c,windMax:m,sunshineSec:d,daylightSec:u,rainMm:p,meta:{lat:[...e.latitude],lon:[...e.longitude],tz:e.timezone}}}buildBattlesFromWeatherSnapshot(t){const[e,a]=[Math.round(t.tmax[0]??20),Math.round(t.tmax[1]??t.tmax[0]??20)],[i,o]=[Math.round(t.windMax[0]??5),Math.round(t.windMax[1]??t.windMax[0]??5)],[s,r]=[Math.round((t.sunshineSec[0]??28800)/3600),Math.round((t.sunshineSec[1]??t.sunshineSec[0]??28800)/3600)];Math.round((t.daylightSec[0]??43200)/3600),Math.round((t.daylightSec[1]??t.daylightSec[0]??43200)/3600);const[n,c]=[Math.round(t.rainMm[0]??0),Math.round(t.rainMm[1]??t.rainMm[0]??0)],m=(u,p,h)=>Math.max(p,Math.min(h,u)),d={id:l("battle"),title:"最高気温",subtitle:"あついね",overview:"",scenario:"くまがややふちゅうには負けない",provenance:[{label:"Open-Meteo - Free Weather API",url:"https://open-meteo.com",note:"Daily metrics used."}],yono:{imageUrl:"/yonokomae/YONO-SYMBOL.png",title:`${e}°C`,subtitle:"",description:`日照 ${s}h、降水 ${n}mm。熱が士気を押し上げる。`,power:m(30+e,25,90)},komae:{imageUrl:"/yonokomae/KOMAE-SYMBOL.png",title:`${a}°C`,subtitle:"",description:`日照 ${r}h、降水 ${c}mm。風が戦況を揺さぶる。`,power:m(25+o*2,25,90)},status:"success"};return l("battle"),`${e}${o}${s}${r}${n}${c}${t.meta.tz}`,l("battle"),l("battle"),[d]}}export{f as NewsReporterApiBattleReportRepository};
