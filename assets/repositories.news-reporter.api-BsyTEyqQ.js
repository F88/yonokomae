import{u as m}from"./index-BzKMk8Ca.js";import{a as y}from"./delay-utils-lugK4fzg.js";class u extends Error{name="NewsReporterError";constructor(t){super(t)}}class d extends u{service;status;constructor(t,e){super(`${t} HTTP ${e}`),this.service=t,this.status=e}}class h extends u{constructor(t){super(t)}}class f{api;delay;cacheTtlMs;cache=null;chooseSource;chooseVariant;constructor(t,e){this.api=t,this.delay=e?.delay,this.cacheTtlMs=Math.max(0,e?.cacheTtlMs??3e4),this.chooseSource=e?.chooser??(()=>Math.random()<.2?"ipify":"weather"),this.chooseVariant=e?.variantChooser??(r=>{const a=Math.random(),o=Math.floor(a*r);return o>=0&&o<r?o:0})}async generateReport(t){await y(this.delay,t?.signal);const e=Date.now();if(this.cache&&this.cache.expiresAt>e)return this.cache.value;const r=this.chooseSource();try{const a=r==="ipify"?await this.generateFromIpify(t?.signal):await this.generateWeatherForecast(t?.signal);return this.maybeStoreCache(a),a}catch{const a=await this.api.get("/news/battle/report",t?.signal);return this.maybeStoreCache(a),a}}maybeStoreCache(t){this.cacheTtlMs!==0&&(this.cache={value:t,expiresAt:Date.now()+this.cacheTtlMs})}async generateFromIpify(t){const e=await fetch("https://api.ipify.org?format=json",{headers:{Accept:"application/json"},signal:t});if(!e.ok)throw new d("ipify",e.status);const r=await e.json(),a=typeof r?.ip=="string"&&r.ip?r.ip:"0.0.0.0",o=a.replace(/[^\d]/g,""),s=o?parseInt(o.slice(-6),10):42,i=s%50+25,n=Math.floor(s/7)%50+25;return{id:m("battle"),themeId:"information",significance:"low",title:`IPアドレス ${a}`,subtitle:"Generated from ipify.org",narrative:{overview:"A network-sourced battle report generated from your current public IP.",scenario:"Signal intelligence gathered from ipify inspires a spontaneous skirmish."},provenance:[{label:"ipify - A Simple Public IP Address API",url:"https://ipify.org",note:"The public IP address used to generate this report."}],yono:{imageUrl:"/yonokomae/YONO-SYMBOL.png",title:"Yono - IP Signal",subtitle:"Live network signal",description:"インターネット便利ねー",power:i},komae:{imageUrl:"/yonokomae/KOMAE-SYMBOL.png",title:"Komae - IP Signal",subtitle:"Live network signal",description:"インターネット便利なー",power:n},status:"success"}}async generateWeatherForecast(t){const e=await this.fetchWeatherSnapshot(t),r=this.buildBattlesFromWeatherSnapshot(e);if(r.length===0)throw new h("No weather-based battle variants generated");const a=this.chooseVariant(r.length),o=r[a]??r[0];if(!o)throw new h("Failed to choose a weather battle variant");return o}async fetchWeatherSnapshot(t){const e={latitude:[35.88445483617253,35.63497080831211],longitude:[139.6262162096776,139.5789225059554],daily:["temperature_2m_max","daylight_duration","sunshine_duration","rain_sum","wind_speed_10m_max"],timezone:"Asia/Tokyo",past_days:1,forecast_days:1},r="https://api.open-meteo.com/v1/forecast",a=new URLSearchParams({latitude:e.latitude.join(","),longitude:e.longitude.join(","),daily:e.daily.join(","),timezone:e.timezone,past_days:String(e.past_days),forecast_days:String(e.forecast_days)}),o=await fetch(`${r}?${a.toString()}`,{headers:{Accept:"application/json"},signal:t});if(!o.ok)throw new d("open-meteo",o.status);const s=await o.json(),i=Array.isArray(s)&&s.length>0?s[0]:void 0,n=Array.isArray(s)&&s.length>1?s[1]:void 0,l=this.pivotDailyFirstTwo({daily:i?.daily}),p=this.pivotDailyFirstTwo({daily:n?.daily});if(!l[1]||!p[1])throw new h("Incomplete weather snapshot: missing daily entries");return{yono:l[1],komae:p[1]}}buildBattlesFromWeatherSnapshot(t){const e=(a,o,s)=>Math.max(o,Math.min(s,a));return[{id:m("battle"),themeId:"information",significance:"low",title:"最高気温",subtitle:"あついね",narrative:{overview:"",scenario:"くまがややふちゅうにだって負けてない!!"},provenance:[{label:"Open-Meteo - Free Weather API",url:"https://open-meteo.com",note:"Daily metrics used."}],yono:{imageUrl:"/yonokomae/YONO-SYMBOL.png",title:`${t.yono.temperature_2m_max}°C`,subtitle:"あついー",description:"",power:e(30+t.yono.temperature_2m_max,25,90)},komae:{imageUrl:"/yonokomae/KOMAE-SYMBOL.png",title:`${t.komae.temperature_2m_max}°C`,subtitle:"あついー",description:"",power:e(25+t.komae.wind_speed_10m_max*2,25,90)},status:"success"}]}pivotDailyFirstTwo(t){const e=t.daily??{},r=i=>{const n=Number(i);return Number.isFinite(n)?n:0},a=(i,n)=>Array.isArray(i)?i[n]:void 0,o=i=>({time:String(a(e.time,i)??""),temperature_2m_max:r(a(e.temperature_2m_max,i)),daylight_duration:r(a(e.daylight_duration,i)),sunshine_duration:r(a(e.sunshine_duration,i)),rain_sum:r(a(e.rain_sum,i)),wind_speed_10m_max:r(a(e.wind_speed_10m_max,i))}),s=[];return s.push(o(0)),s.push(o(1)),s}}export{f as NewsReporterApiBattleReportRepository,h as NewsReporterDataError,u as NewsReporterError,d as NewsReporterHttpError};
