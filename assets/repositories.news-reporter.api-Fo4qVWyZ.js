import{u as m}from"./index-hm925-4y.js";import{a as y}from"./delay-utils-lugK4fzg.js";class u extends Error{name="NewsReporterError";constructor(t){super(t)}}class d extends u{service;status;constructor(t,e){super(`${t} HTTP ${e}`),this.service=t,this.status=e}}class h extends u{constructor(t){super(t)}}class f{api;delay;cacheTtlMs;cache=null;chooseSource;chooseVariant;constructor(t,e){this.api=t,this.delay=e?.delay,this.cacheTtlMs=Math.max(0,e?.cacheTtlMs??3e4),this.chooseSource=e?.chooser??(()=>Math.random()<.2?"ipify":"weather"),this.chooseVariant=e?.variantChooser??(o=>{const r=Math.random(),a=Math.floor(r*o);return a>=0&&a<o?a:0})}async generateReport(t){const e=t?.signal;await y(this.delay,e);const o=Date.now();if(this.cache&&this.cache.expiresAt>o)return this.cache.value;const r=this.chooseSource();try{const a=r==="ipify"?await this.generateFromIpify(e):await this.generateWeatherForecast(e);return this.maybeStoreCache(a),a}catch{const a=await this.api.get("/news/battle/report",e);return this.maybeStoreCache(a),a}}maybeStoreCache(t){this.cacheTtlMs!==0&&(this.cache={value:t,expiresAt:Date.now()+this.cacheTtlMs})}async generateFromIpify(t){const e=await fetch("https://api.ipify.org?format=json",{headers:{Accept:"application/json"},signal:t});if(!e.ok)throw new d("ipify",e.status);const o=await e.json(),r=typeof o?.ip=="string"&&o.ip?o.ip:"0.0.0.0",a=r.replace(/[^\d]/g,""),s=a?parseInt(a.slice(-6),10):42,i=s%50+25,n=Math.floor(s/7)%50+25;return{id:m("battle"),themeId:"information",significance:"low",title:`IPアドレス ${r}`,subtitle:"Generated from ipify.org",narrative:{overview:"A network-sourced battle report generated from your current public IP.",scenario:"Signal intelligence gathered from ipify inspires a spontaneous skirmish."},provenance:[{label:"ipify - A Simple Public IP Address API",url:"https://ipify.org",note:"The public IP address used to generate this report."}],yono:{imageUrl:"/yonokomae/YONO-SYMBOL.png",title:"Yono - IP Signal",subtitle:"Live network signal",description:"インターネット便利ねー",power:i},komae:{imageUrl:"/yonokomae/KOMAE-SYMBOL.png",title:"Komae - IP Signal",subtitle:"Live network signal",description:"インターネット便利なー",power:n},status:"success"}}async generateWeatherForecast(t){const e=await this.fetchWeatherSnapshot(t),o=this.buildBattlesFromWeatherSnapshot(e);if(o.length===0)throw new h("No weather-based battle variants generated");const r=this.chooseVariant(o.length),a=o[r]??o[0];if(!a)throw new h("Failed to choose a weather battle variant");return a}async fetchWeatherSnapshot(t){const e={latitude:[35.88445483617253,35.63497080831211],longitude:[139.6262162096776,139.5789225059554],daily:["temperature_2m_max","daylight_duration","sunshine_duration","rain_sum","wind_speed_10m_max"],timezone:"Asia/Tokyo",past_days:1,forecast_days:1},o="https://api.open-meteo.com/v1/forecast",r=new URLSearchParams({latitude:e.latitude.join(","),longitude:e.longitude.join(","),daily:e.daily.join(","),timezone:e.timezone,past_days:String(e.past_days),forecast_days:String(e.forecast_days)}),a=await fetch(`${o}?${r.toString()}`,{headers:{Accept:"application/json"},signal:t});if(!a.ok)throw new d("open-meteo",a.status);const s=await a.json(),i=Array.isArray(s)&&s.length>0?s[0]:void 0,n=Array.isArray(s)&&s.length>1?s[1]:void 0,l=this.pivotDailyFirstTwo({daily:i?.daily}),p=this.pivotDailyFirstTwo({daily:n?.daily});if(!l[1]||!p[1])throw new h("Incomplete weather snapshot: missing daily entries");return{yono:l[1],komae:p[1]}}buildBattlesFromWeatherSnapshot(t){const e=(r,a,s)=>Math.max(a,Math.min(s,r));return[{id:m("battle"),themeId:"information",significance:"low",title:"最高気温",subtitle:"あついね",narrative:{overview:"",scenario:"くまがややふちゅうにだって負けてない!!"},provenance:[{label:"Open-Meteo - Free Weather API",url:"https://open-meteo.com",note:"Daily metrics used."}],yono:{imageUrl:"/yonokomae/YONO-SYMBOL.png",title:`${t.yono.temperature_2m_max}°C`,subtitle:"あついー",description:"",power:e(30+t.yono.temperature_2m_max,25,90)},komae:{imageUrl:"/yonokomae/KOMAE-SYMBOL.png",title:`${t.komae.temperature_2m_max}°C`,subtitle:"あついー",description:"",power:e(25+t.komae.wind_speed_10m_max*2,25,90)},status:"success"}]}pivotDailyFirstTwo(t){const e=t.daily??{},o=i=>{const n=Number(i);return Number.isFinite(n)?n:0},r=(i,n)=>Array.isArray(i)?i[n]:void 0,a=i=>({time:String(r(e.time,i)??""),temperature_2m_max:o(r(e.temperature_2m_max,i)),daylight_duration:o(r(e.daylight_duration,i)),sunshine_duration:o(r(e.sunshine_duration,i)),rain_sum:o(r(e.rain_sum,i)),wind_speed_10m_max:o(r(e.wind_speed_10m_max,i))}),s=[];return s.push(a(0)),s.push(a(1)),s}}export{f as NewsReporterApiBattleReportRepository,h as NewsReporterDataError,u as NewsReporterError,d as NewsReporterHttpError};
